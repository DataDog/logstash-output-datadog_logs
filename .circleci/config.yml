version: 2.1

jobs:
  logstash_v5:
    machine: true
    steps:
      - checkout
      - run:
          name: Install Ruby
          command: sudo apt-get update && sudo apt-get install ruby-full
      - run:
          name: Build Gem
          command: gem build logstash-output-datadog_logs.gemspec
      - run:
          name: Install Java
          command: sudo apt-get update && sudo apt-get install openjdk-8-jre
      - run:
          name: Install Logstash
          command: |
            wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add -
            sudo apt-get install apt-transport-https
            echo "deb https://artifacts.elastic.co/packages/5.x/apt stable main" | sudo tee -a /etc/apt/sources.list.d/elastic-5.x.list
            sudo apt-get update && sudo apt-get install logstash
      - run:
          name: Install Plugin
          command: logstash-plugin install --local logstash-output-datadog_logs-0.4.1.gem

  logstash_v6:
    machine: true
    steps:
      - checkout
      - run:
          name: Install Ruby
          command: sudo apt-get update && sudo apt-get install ruby-full
      - run:
          name: Build Gem
          command: gem build logstash-output-datadog_logs.gemspec
      - run:
          name: Install Java
          command: sudo apt-get update && sudo apt-get install openjdk-8-jre
      - run:
          name: Install Logstash
          command: |
            wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add -
            sudo apt-get install apt-transport-https
            echo "deb https://artifacts.elastic.co/packages/6.x/apt stable main" | sudo tee -a /etc/apt/sources.list.d/elastic-6.x.list
            sudo apt-get update && sudo apt-get install logstash
      - run:
          name: Install Plugin
          command: logstash-plugin install --local logstash-output-datadog_logs-0.4.1.gem

  logstash_v7:
    machine: true
    steps:
      - checkout
      - run:
          name: Install Ruby
          command: sudo apt-get update && sudo apt-get install ruby-full
      - run:
          name: Build Gem
          command: gem build logstash-output-datadog_logs.gemspec
      - run:
          name: Install Java
          command: sudo apt-get update && sudo apt-get install openjdk-8-jre
      - run:
          name: Install Logstash
          command: |
            wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add -
            sudo apt-get install apt-transport-https
            echo "deb https://artifacts.elastic.co/packages/7.x/apt stable main" | sudo tee -a /etc/apt/sources.list.d/elastic-7.x.list
            sudo apt-get update && sudo apt-get install logstash
      - run:
          name: Install Plugin
          command: logstash-plugin install --local logstash-output-datadog_logs-0.4.1.gem

workflows:
  version: 2.1
  test_logstash:
    jobs:
      - logstash_v5
      - logstash_v6
      - logstash_v7
